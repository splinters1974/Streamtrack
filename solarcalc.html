<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Industrial & Commercial Solar Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Familjen+Grotesk:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --navy: #0a0e1a;
      --navy-2: #111827;
      --navy-3: #1c2537;
      --navy-4: #243049;
      --amber: #f59e0b;
      --amber-light: #fbbf24;
      --amber-dim: rgba(245,158,11,0.12);
      --sky: #38bdf8;
      --sky-dim: rgba(56,189,248,0.1);
      --green: #34d399;
      --green-dim: rgba(52,211,153,0.1);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
      --border: rgba(255,255,255,0.07);
      --border-hover: rgba(245,158,11,0.4);
      --card-bg: rgba(255,255,255,0.03);
      --card-bg-hover: rgba(255,255,255,0.06);
      --radius: 12px;
      --radius-lg: 20px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Familjen Grotesk', sans-serif;
      background: var(--navy);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Background grid pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(245,158,11,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(245,158,11,0.03) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    /* Ambient glow top */
    body::after {
      content: '';
      position: fixed;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 800px;
      height: 400px;
      background: radial-gradient(ellipse, rgba(245,158,11,0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .wrapper {
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 24px 80px;
    }

    /* ── HEADER ── */
    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 60px;
      padding-bottom: 40px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 120px;
      height: 2px;
      background: var(--amber);
    }

    .header-left { flex: 1; }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--amber-dim);
      border: 1px solid rgba(245,158,11,0.25);
      color: var(--amber);
      font-size: 0.7em;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 6px 14px;
      border-radius: 100px;
      margin-bottom: 20px;
    }

    .sun-dot {
      width: 7px;
      height: 7px;
      background: var(--amber);
      border-radius: 50%;
      animation: pulse-amber 2s ease-in-out infinite;
    }

    @keyframes pulse-amber {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.7); }
    }

    .header h1 {
      font-size: clamp(2em, 4vw, 3.2em);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.02em;
      color: #fff;
      margin-bottom: 14px;
    }

    .header h1 span {
      color: var(--amber);
    }

    .header-sub {
      color: var(--text-muted);
      font-size: 1em;
      font-weight: 400;
      max-width: 480px;
      line-height: 1.6;
    }

    .logo-area {
      width: 100px;
      height: 100px;
      border-radius: var(--radius);
      background: var(--navy-3);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
      margin-left: 30px;
    }

    .logo-area img {
      width: 85%;
      height: 85%;
      object-fit: contain;
    }

    /* ── STEP INDICATOR ── */
    .steps {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 48px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.82em;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-dim);
      transition: color 0.3s;
    }

    .step.active { color: var(--amber); }
    .step.done { color: var(--green); }

    .step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85em;
      font-family: 'JetBrains Mono', monospace;
      flex-shrink: 0;
      transition: all 0.3s;
    }

    .step.active .step-num {
      background: var(--amber);
      border-color: var(--amber);
      color: var(--navy);
    }

    .step.done .step-num {
      background: var(--green);
      border-color: var(--green);
      color: var(--navy);
    }

    .step-line {
      flex: 1;
      height: 1px;
      background: var(--border);
      margin: 0 16px;
      max-width: 80px;
    }

    /* ── INPUT SECTION ── */
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--amber), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover {
      background: var(--card-bg-hover);
      border-color: rgba(245,158,11,0.2);
      transform: translateY(-2px);
    }

    .card:hover::before { opacity: 1; }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .card-icon {
      width: 36px;
      height: 36px;
      background: var(--amber-dim);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      flex-shrink: 0;
    }

    .card-title {
      font-size: 0.85em;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .form-row {
      margin-bottom: 18px;
    }

    .form-row:last-child { margin-bottom: 0; }

    label {
      display: block;
      font-size: 0.78em;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    input, select {
      width: 100%;
      padding: 12px 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95em;
      transition: all 0.25s;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--amber);
      background: rgba(245,158,11,0.05);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.08);
    }

    input::placeholder { color: var(--text-dim); }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      cursor: pointer;
    }

    select option { background: var(--navy-2); color: var(--text); }

    /* ── CALCULATE BUTTON ── */
    .calc-btn {
      width: 100%;
      padding: 18px;
      background: var(--amber);
      color: var(--navy);
      border: none;
      border-radius: var(--radius);
      font-family: 'Familjen Grotesk', sans-serif;
      font-size: 1em;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 60px;
    }

    .calc-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%);
      transform: translateX(-100%);
      transition: transform 0.4s ease;
    }

    .calc-btn:hover {
      background: var(--amber-light);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(245,158,11,0.35);
    }

    .calc-btn:hover::after { transform: translateX(100%); }

    .calc-btn:active { transform: translateY(0); }

    .calc-btn svg { width: 20px; height: 20px; }

    /* ── LOADING ── */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
    }

    .loading-ring {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--amber);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading p {
      color: var(--text-muted);
      font-size: 0.9em;
      letter-spacing: 0.05em;
    }

    /* ── RESULTS ── */
    .results { display: none; animation: fadeUp 0.5s ease; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .results-title {
      font-size: 1.6em;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .results-title span { color: var(--amber); }

    .download-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      font-family: 'Familjen Grotesk', sans-serif;
      font-size: 0.82em;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.25s;
    }

    .download-btn:hover {
      border-color: var(--sky);
      color: var(--sky);
      background: var(--sky-dim);
    }

    /* ── METRICS GRID ── */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .metrics-row-2 {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 40px;
    }

    .metric {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .metric:hover {
      border-color: rgba(245,158,11,0.2);
      background: var(--card-bg-hover);
    }

    .metric-accent {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--amber);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .metric:hover .metric-accent { transform: scaleX(1); }

    .metric.big {
      border-color: rgba(245,158,11,0.2);
      background: var(--amber-dim);
    }

    .metric.big .metric-accent { background: var(--amber); }

    .metric.sky-big {
      border-color: rgba(56,189,248,0.2);
      background: var(--sky-dim);
    }

    .metric.sky-big .metric-accent { background: var(--sky); }

    .metric.green-big {
      border-color: rgba(52,211,153,0.2);
      background: var(--green-dim);
    }

    .metric.green-big .metric-accent { background: var(--green); }

    .metric-label {
      font-size: 0.68em;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.55em;
      font-weight: 500;
      color: #fff;
      line-height: 1;
      margin-bottom: 4px;
    }

    .metric.big .metric-value { color: var(--amber); }
    .metric.sky-big .metric-value { color: var(--sky); }
    .metric.green-big .metric-value { color: var(--green); }

    .metric-unit {
      font-size: 0.72em;
      color: var(--text-dim);
    }

    /* ── CHART ── */
    .chart-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 24px;
      position: relative;
    }

    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .chart-card-title {
      font-size: 0.85em;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .chart-legend {
      display: flex;
      gap: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.75em;
      color: var(--text-muted);
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .chart-wrapper {
      position: relative;
      height: 360px;
    }

    /* ── YEAR BREAKDOWN ── */
    .breakdown-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 24px;
    }

    .breakdown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .breakdown-title {
      font-size: 0.85em;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .bar-rows { display: flex; flex-direction: column; gap: 10px; }

    .bar-row {
      display: grid;
      grid-template-columns: 60px 1fr 100px;
      align-items: center;
      gap: 16px;
    }

    .bar-year {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78em;
      color: var(--text-dim);
      text-align: right;
    }

    .bar-track {
      height: 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--amber), var(--amber-light));
      transform-origin: left;
      transform: scaleX(0);
      transition: transform 0.6s cubic-bezier(0.4,0,0.2,1);
    }

    .bar-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78em;
      color: var(--amber);
      text-align: right;
    }

    /* ── ASSUMPTIONS ── */
    .assumptions-card {
      background: var(--card-bg);
      border: 1px solid rgba(245,158,11,0.15);
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 24px;
    }

    .assumptions-title {
      font-size: 0.75em;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .assumptions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .assumption-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 0.8em;
      line-height: 1.5;
      color: var(--text-muted);
    }

    .assumption-item::before {
      content: '//';
      font-family: 'JetBrains Mono', monospace;
      color: var(--amber);
      opacity: 0.5;
      flex-shrink: 0;
      margin-top: 1px;
      font-size: 0.85em;
    }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .metrics-grid, .metrics-row-2 { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 700px) {
      .input-grid { grid-template-columns: 1fr; }
      .metrics-grid, .metrics-row-2 { grid-template-columns: repeat(2, 1fr); }
      .assumptions-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 20px; }
      .logo-area { margin-left: 0; }
    }

    @media (max-width: 480px) {
      .metrics-grid, .metrics-row-2 { grid-template-columns: 1fr 1fr; }
    }

    /* ── ERROR MESSAGE ── */
    .error-msg {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.4);
      border-radius: var(--radius);
      padding: 16px 20px;
      color: #fca5a5;
      font-size: 0.88em;
      line-height: 1.6;
      margin-top: -20px;
      margin-bottom: 32px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .error-msg::before {
      content: '⚠';
      flex-shrink: 0;
      color: #f87171;
      font-size: 1.1em;
    }

    /* ── CONTACT CTA ── */
    .contact-card {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(245,158,11,0.03));
      border: 1px solid rgba(245,158,11,0.35);
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 24px;
    }

    .contact-icon {
      width: 44px;
      height: 44px;
      background: var(--amber-dim);
      border: 1px solid rgba(245,158,11,0.25);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .contact-body { flex: 1; }

    .contact-label {
      font-size: 0.68em;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--amber);
      margin-bottom: 8px;
    }

    .contact-text {
      font-size: 0.88em;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .contact-person {
      font-size: 1.05em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 6px;
    }

    .contact-details {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .contact-details a {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em;
      color: var(--amber);
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .contact-details a:hover { opacity: 0.75; text-decoration: underline; }

    .contact-divider { color: var(--text-dim); }

    /* ── CONTACT CTA ── */
  </style>
</head>
<body>
<div class="wrapper">

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="header-badge">
        <span class="sun-dot"></span>
        Industrial & Commercial
      </div>
      <h1>Solar<br><span>Calculator</span></h1>
      <p class="header-sub">Estimate your solar potential, installation cost, and 30-year ROI for commercial and industrial rooftops.</p>
    </div>
    <div class="logo-area">
      <img src="/mnt/kimi/upload/image.png" alt="Logo" onerror="this.parentElement.innerHTML='<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23f59e0b\' stroke-width=\'1.5\'><circle cx=\'12\' cy=\'12\' r=\'4\'/><path d=\'M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41\'/></svg>'">
    </div>
  </header>

  <!-- STEP INDICATOR -->
  <div class="steps" id="stepIndicator">
    <div class="step active" id="step1">
      <div class="step-num">1</div>
      <span>Building Details</span>
    </div>
    <div class="step-line"></div>
    <div class="step" id="step2">
      <div class="step-num">2</div>
      <span>Energy & Location</span>
    </div>
    <div class="step-line"></div>
    <div class="step" id="step3">
      <div class="step-num">3</div>
      <span>Your Results</span>
    </div>
  </div>

  <!-- INPUT SECTION -->
  <div class="input-grid">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        </div>
        <span class="card-title">Building Specifications</span>
      </div>
      <div class="form-row">
        <label>Length (metres)</label>
        <input type="number" id="length" placeholder="e.g. 50" step="0.1" min="1">
      </div>
      <div class="form-row">
        <label>Width (metres)</label>
        <input type="number" id="width" placeholder="e.g. 30" step="0.1" min="1">
      </div>
      <div class="form-row">
        <label>Roof Type</label>
        <select id="roofType">
          <option value="pitched">Pitched Roof</option>
          <option value="flat">Flat Roof</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        </div>
        <span class="card-title">Energy & Location</span>
      </div>
      <div class="form-row">
        <label>Region</label>
        <select id="region">
          <option value="scotland">Scotland</option>
          <option value="north">North England</option>
          <option value="midlands">Midlands / Wales</option>
          <option value="southwest">South West</option>
          <option value="southeast">South East</option>
        </select>
      </div>
      <div class="form-row">
        <label>Current Energy Price (p/kWh)</label>
        <input type="number" id="energyPrice" value="25" step="0.1" min="1">
      </div>
    </div>
  </div>

  <button class="calc-btn" onclick="calculateSolar()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
    Calculate Solar Potential
  </button>

  <div class="error-msg" id="errorMsg" style="display:none"></div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="loading-ring"></div>
    <p>Running calculations…</p>
  </div>

  <!-- RESULTS -->
  <div class="results" id="results">

    <div class="results-header">
      <div class="results-title">Your Solar <span>Analysis</span></div>
      <button class="download-btn" onclick="downloadPDF()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Download PDF
      </button>
    </div>

    <!-- ROW 1: System metrics -->
    <div class="metrics-grid">
      <div class="metric">
        <div class="metric-label">Roof Area</div>
        <div class="metric-value" id="roofArea">—</div>
        <div class="metric-unit">m²</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Panels Fitted</div>
        <div class="metric-value" id="panelCount">—</div>
        <div class="metric-unit">× 450W</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric">
        <div class="metric-label">System Size</div>
        <div class="metric-value" id="systemSize">—</div>
        <div class="metric-unit">kWp</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Year 1 Generation</div>
        <div class="metric-value" id="annualGen">—</div>
        <div class="metric-unit">kWh</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric">
        <div class="metric-label">30yr Generation</div>
        <div class="metric-value" id="totalGen">—</div>
        <div class="metric-unit">kWh</div>
        <div class="metric-accent"></div>
      </div>
    </div>

    <!-- ROW 2: Financial highlights -->
    <div class="metrics-row-2">
      <div class="metric big">
        <div class="metric-label">Installation Cost</div>
        <div class="metric-value" id="totalCost">—</div>
        <div class="metric-unit">GBP total</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric big">
        <div class="metric-label">30yr Savings</div>
        <div class="metric-value" id="totalSavings">—</div>
        <div class="metric-unit">GBP</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric sky-big">
        <div class="metric-label">Return on Investment</div>
        <div class="metric-value" id="roi">—</div>
        <div class="metric-unit">% over 30 years</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric sky-big">
        <div class="metric-label">Payback Period</div>
        <div class="metric-value" id="payback">—</div>
        <div class="metric-unit">years</div>
        <div class="metric-accent"></div>
      </div>
      <div class="metric green-big">
        <div class="metric-label">CO₂ Offset</div>
        <div class="metric-value" id="carbon">—</div>
        <div class="metric-unit">tonnes (30yr)</div>
        <div class="metric-accent"></div>
      </div>
    </div>

    <!-- CHART -->
    <div class="chart-card">
      <div class="chart-card-header">
        <span class="chart-card-title">Break-Even Analysis</span>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--amber)"></div>
            Cumulative Savings
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--sky);opacity:0.6"></div>
            Initial Investment
          </div>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="savingsChart"></canvas>
      </div>
    </div>

    <!-- YEAR BREAKDOWN -->
    <div class="breakdown-card">
      <div class="breakdown-header">
        <span class="breakdown-title">Year-by-Year Savings — First 10 Years</span>
      </div>
      <div class="bar-rows" id="barRows"></div>
    </div>

    <!-- ASSUMPTIONS -->
    <div class="assumptions-card">
      <div class="assumptions-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
        Assumptions & Limitations
      </div>
      <div class="assumptions-grid">
        <div class="assumption-item">Maintenance costs NOT included. Typically £15–£20/kWp/year.</div>
        <div class="assumption-item">Roof coverage: 80% of total roof area assumed usable, accounting for edge setbacks, obstructions, vents, and inter-row spacing.</div>
        <div class="assumption-item">Self-consumption: 90% of generation is assumed consumed on-site, displacing grid electricity at the import rate. The remaining 10% exported is not valued.</div>
        <div class="assumption-item">Panel degradation: 2% per year (industry standard).</div>
        <div class="assumption-item">Electricity price inflation: 3% per year.</div>
        <div class="assumption-item">Panel spec: 450W, 2.27m × 1.13m (2.57m²). System efficiency: 85%.</div>
        <div class="assumption-item">Carbon factor: 0.233 kg CO₂/kWh (UK grid average).</div>
        <div class="assumption-item">Does not include costs for scaffolding, surveys such as structural and also any grid associated costs or upgrades.</div>
      </div>
    </div>

    <!-- CONTACT CTA -->
    <div class="contact-card">
      <div class="contact-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <div class="contact-body">
        <div class="contact-label">Important Notice</div>
        <div class="contact-text">This is a rough, hypothetical calculation based on very basic input information. For a more detailed design and accurate costings and savings please contact:</div>
        <div class="contact-person">Martyn Sheridan</div>
        <div class="contact-details">
          <a href="/cdn-cgi/l/email-protection#7815190a0c01160b101d0a111c1916381f15191114561b1715"><span class="__cf_email__" data-cfemail="dcb1bdaea8a5b2afb4b9aeb5b8bdb29cbbb1bdb5b0f2bfb3b1">[email&#160;protected]</span></a>
          <span class="contact-divider">·</span>
          <a href="tel:+447872015769">+44 (0) 787 2015769</a>
        </div>
      </div>
    </div>

  </div><!-- /results -->
</div><!-- /wrapper -->

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
  const PANEL_POWER = 450;
  const PANEL_AREA = 2.27 * 1.13;
  const PANEL_COST_PER_WATT = 0.10;
  const SYSTEM_EFFICIENCY = 0.85;
  const DEGRADATION_RATE = 0.02;
  const PRICE_INFLATION = 0.03;
  const CARBON_FACTOR = 0.233;
  const SYSTEM_LIFETIME = 30;
  const ROOF_COVERAGE = 0.80;        // 80% of roof area is usable for panels
  const SELF_CONSUMPTION = 0.90;     // 90% of generation is consumed on-site; remainder exported but not valued

  const REGIONAL_YIELD = { scotland:800, north:900, midlands:1000, southwest:1100, southeast:1150 };
  const INSTALL_COST = { pitched:800, flat:900 };
  const MIN_ROOF_AREA = 350;   // m² — minimum building footprint accepted
  const MIN_SYSTEM_KWP = 50;   // kWp — minimum viable system size

  let calculationData = null;
  let currentChart = null;

  function fmt(n, dec=0) {
    return n.toLocaleString('en-GB', { minimumFractionDigits:dec, maximumFractionDigits:dec });
  }

  function animateCount(el, from, to, prefix='', suffix='', decimals=0, duration=900) {
    const start = performance.now();
    function tick(now) {
      const p = Math.min((now - start) / duration, 1);
      const ease = 1 - Math.pow(1 - p, 4);
      const val = from + (to - from) * ease;
      el.textContent = prefix + fmt(val, decimals) + suffix;
      if (p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'flex';
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function hideError() {
    document.getElementById('errorMsg').style.display = 'none';
  }

  function calculateSolar() {
    const length = parseFloat(document.getElementById('length').value);
    const width = parseFloat(document.getElementById('width').value);
    const roofType = document.getElementById('roofType').value;
    const region = document.getElementById('region').value;
    const energyPrice = parseFloat(document.getElementById('energyPrice').value) / 100;

    if (!length || !width || length <= 0 || width <= 0) {
      showError('Please enter valid building dimensions.');
      return;
    }

    const roofArea = length * width;
    if (roofArea < MIN_ROOF_AREA) {
      showError(`Building footprint is ${roofArea.toFixed(0)} m² — the minimum accepted is ${MIN_ROOF_AREA} m². This calculator is designed for larger commercial and industrial buildings only.`);
      return;
    }

    // Pre-check system size before full compute
    const usableArea = roofArea * ROOF_COVERAGE;
    const estPanels = Math.floor(usableArea / PANEL_AREA);
    const estKwp = (estPanels * PANEL_POWER) / 1000;
    if (estKwp < MIN_SYSTEM_KWP) {
      showError(`Estimated system size is ${estKwp.toFixed(1)} kWp — the minimum accepted is ${MIN_SYSTEM_KWP} kWp. Please enter a larger building.`);
      return;
    }

    hideError();

    // Update steps
    document.getElementById('step1').className = 'step done';
    document.getElementById('step2').className = 'step done';
    document.getElementById('step3').className = 'step active';

    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';

    setTimeout(() => {
      const data = compute(length, width, roofType, region, energyPrice);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').scrollIntoView({ behavior:'smooth' });
      renderResults(data);
    }, 700);
  }

  function compute(length, width, roofType, region, energyPrice) {
    const roofArea = length * width;
    const usableRoofArea = roofArea * ROOF_COVERAGE;
    const maxPanels = Math.floor(usableRoofArea / PANEL_AREA);
    const systemSizeKw = (maxPanels * PANEL_POWER) / 1000;
    const hardwareCost = systemSizeKw * 1000 * PANEL_COST_PER_WATT;
    const installationCost = systemSizeKw * INSTALL_COST[roofType];
    const totalCost = hardwareCost + installationCost;
    const yearOneGeneration = systemSizeKw * REGIONAL_YIELD[region] * SYSTEM_EFFICIENCY;

    let yearlyGeneration = [], yearlySavings = [], cumulativeData = [];
    let totalGeneration = 0, cumulativeSavings = 0, paybackYear = null;

    for (let y = 1; y <= SYSTEM_LIFETIME; y++) {
      const gen = yearOneGeneration * Math.pow(1 - DEGRADATION_RATE, y - 1);
      const price = energyPrice * Math.pow(1 + PRICE_INFLATION, y - 1);
      // Only the self-consumed portion displaces grid electricity at the import rate
      const sav = gen * SELF_CONSUMPTION * price;
      yearlyGeneration.push(gen);
      yearlySavings.push(sav);
      totalGeneration += gen;
      cumulativeSavings += sav;
      cumulativeData.push(cumulativeSavings);
      if (!paybackYear && cumulativeSavings >= totalCost) {
        paybackYear = y - 1 + (totalCost - (cumulativeSavings - sav)) / sav;
      }
    }

    const totalSavings = yearlySavings.reduce((a,b)=>a+b,0);
    const roi = ((totalSavings - totalCost) / totalCost) * 100;
    const carbonOffset = (totalGeneration * CARBON_FACTOR) / 1000;

    calculationData = {
      inputs:{ length, width, roofType, region, energyPrice:energyPrice*100 },
      results:{ roofArea, maxPanels, systemSizeKw, totalCost, yearOneGeneration,
                totalGeneration, totalSavings, roi, paybackYear:paybackYear||SYSTEM_LIFETIME,
                carbonOffset, yearlySavings, yearlyGeneration },
      date: new Date().toLocaleDateString('en-GB')
    };
    return calculationData;
  }

  function renderResults(data) {
    const r = data.results;

    // Animated count-ups
    animateCount(document.getElementById('roofArea'), 0, r.roofArea, '', '', 1);
    animateCount(document.getElementById('panelCount'), 0, r.maxPanels);
    animateCount(document.getElementById('systemSize'), 0, r.systemSizeKw, '', '', 2);
    animateCount(document.getElementById('annualGen'), 0, r.yearOneGeneration);
    animateCount(document.getElementById('totalGen'), 0, r.totalGeneration);
    animateCount(document.getElementById('totalCost'), 0, r.totalCost, '£');
    animateCount(document.getElementById('totalSavings'), 0, r.totalSavings, '£');
    animateCount(document.getElementById('roi'), 0, r.roi, '', '', 1);
    animateCount(document.getElementById('payback'), 0, r.paybackYear, '', '', 1);
    animateCount(document.getElementById('carbon'), 0, r.carbonOffset, '', '', 1);

    // Bar chart (year-by-year)
    const maxSav = Math.max(...r.yearlySavings.slice(0,10));
    const barRows = document.getElementById('barRows');
    barRows.innerHTML = '';
    r.yearlySavings.slice(0,10).forEach((sav, i) => {
      const row = document.createElement('div');
      row.className = 'bar-row';
      row.innerHTML = `
        <span class="bar-year">Yr ${i+1}</span>
        <div class="bar-track"><div class="bar-fill" id="bf${i}" style="width:${(sav/maxSav)*100}%"></div></div>
        <span class="bar-value">£${fmt(sav)}</span>
      `;
      barRows.appendChild(row);
    });

    // Animate bars after a tick
    setTimeout(() => {
      document.querySelectorAll('.bar-fill').forEach((el, i) => {
        el.style.transitionDelay = `${i * 60}ms`;
        el.style.transform = 'scaleX(1)';
      });
    }, 100);

    // Line chart
    buildChart(r.totalCost, r.yearlySavings, r.paybackYear || SYSTEM_LIFETIME);
  }

  function buildChart(cost, yearlySavings, paybackYear) {
    const canvasCtx = document.getElementById('savingsChart').getContext('2d');
    if (currentChart) currentChart.destroy();

    // Build cumulative
    let cum = 0;
    const cumulativeData = yearlySavings.map(s => { cum += s; return cum; });
    const labels = Array.from({length:30}, (_,i) => `Y${i+1}`);
    const paybackIndex = Math.round(paybackYear) - 1;

    // Break-even line drawn via inline plugin — registered BEFORE chart creation
    const breakEvenPlugin = {
      id: 'breakEvenLine',
      afterDraw(chart) {
        const { ctx: c, scales: { x, y } } = chart;
        const xPos = x.getPixelForValue(paybackIndex);
        const top = y.top;
        const bottom = y.bottom;
        c.save();
        c.setLineDash([4, 3]);
        c.strokeStyle = 'rgba(52,211,153,0.6)';
        c.lineWidth = 1.5;
        c.beginPath();
        c.moveTo(xPos, top);
        c.lineTo(xPos, bottom);
        c.stroke();
        c.setLineDash([]);
        c.fillStyle = '#34d399';
        c.font = '600 10px JetBrains Mono, monospace';
        c.fillText(`Break-even: Yr ${paybackYear.toFixed(1)}`, xPos + 6, top + 16);
        c.restore();
      }
    };

    currentChart = new Chart(canvasCtx, {
      type: 'line',
      plugins: [breakEvenPlugin],
      data: {
        labels,
        datasets: [
          {
            label: 'Cumulative Savings',
            data: cumulativeData,
            borderColor: '#f59e0b',
            backgroundColor: (context) => {
              const chart = context.chart;
              const { chartArea } = chart;
              if (!chartArea) return 'rgba(245,158,11,0.1)';
              const g = chart.ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
              g.addColorStop(0, 'rgba(245,158,11,0.2)');
              g.addColorStop(1, 'rgba(245,158,11,0)');
              return g;
            },
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: '#f59e0b',
            borderWidth: 2.5,
          },
          {
            label: 'Initial Investment',
            data: Array(30).fill(cost),
            borderColor: 'rgba(56,189,248,0.5)',
            borderDash: [6, 4],
            fill: false,
            pointRadius: 0,
            borderWidth: 1.5,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(10,14,26,0.95)',
            borderColor: 'rgba(245,158,11,0.3)',
            borderWidth: 1,
            titleColor: '#94a3b8',
            bodyColor: '#e2e8f0',
            titleFont: { family: 'JetBrains Mono', size: 11 },
            bodyFont: { family: 'JetBrains Mono', size: 12 },
            padding: 12,
            callbacks: {
              label: item => ` ${item.dataset.label}: £${item.parsed.y.toLocaleString('en-GB', { maximumFractionDigits: 0 })}`
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.04)' },
            ticks: {
              color: '#475569',
              font: { family: 'JetBrains Mono', size: 10 },
              maxTicksLimit: 10
            }
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,0.04)' },
            ticks: {
              color: '#475569',
              font: { family: 'JetBrains Mono', size: 10 },
              callback: v => '£' + (v / 1000).toFixed(0) + 'k'
            }
          }
        }
      }
    });
  }

  async function downloadPDF() {
    if (!calculationData) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4' });
    const r   = calculationData.results;
    const inp = calculationData.inputs;

    const PW = 210, PH = 297;
    const ML = 14, MR = 14, CW = PW - ML - MR;
    const COL_GAP = 6;
    const COL_W   = (CW - COL_GAP) / 2;
    const C1L = ML;
    const C2L = ML + COL_W + COL_GAP;
    const ROW_H   = 6.5;
    const SEC_H   = 7;

    // Colours
    const BLACK  = [20,  20,  20];
    const DGREY  = [80,  80,  80];
    const MGREY  = [140, 140, 140];
    const LGREY  = [210, 210, 210];
    const AMBER  = [245, 158, 11];
    const BLUE   = [0,   90,  160];
    const GREEN  = [0,   110, 80];
    const SLATE  = [71,  85,  105];
    const RED    = [185, 28,  28];

    // Typography helper
    function T(style, size, color) {
      doc.setFont('helvetica', style);
      doc.setFontSize(size);
      doc.setTextColor(...color);
    }

    // Section heading: left accent bar + light tint + bold label
    // Returns y of first data row
    function sectionHead(title, accent, bgRGB, x, y, w) {
      // Light tinted background
      doc.setFillColor(...bgRGB);
      doc.rect(x, y, w, SEC_H, 'F');
      // Left accent strip (3mm wide)
      doc.setFillColor(...accent);
      doc.rect(x, y, 3, SEC_H, 'F');
      // Label — left-padded past the accent strip
      T('bold', 8.5, accent);
      doc.text(title, x + 6, y + SEC_H - 2);
      // Return y for first row — leave a clear gap below the bar
      return y + SEC_H + 4;
    }

    // Data row: grey label left, bold value right, hairline rule below
    function dataRow(label, value, x, y, w) {
      T('normal', 8, DGREY);
      doc.text(label, x, y);
      T('bold', 8, BLACK);
      doc.text(String(value), x + w, y, { align: 'right' });
      doc.setDrawColor(...LGREY);
      doc.setLineWidth(0.15);
      doc.line(x, y + 1.8, x + w, y + 1.8);
      return y + ROW_H;
    }

    // ── HEADER (white bg, black text, amber top stripe) ──────────────
    doc.setFillColor(...AMBER);
    doc.rect(0, 0, PW, 2.5, 'F');

    T('bold', 17, BLACK);
    doc.text('Industrial & Commercial Solar Calculator', ML, 13);

    T('normal', 9, SLATE);
    doc.text('Solar Energy Solutions  —  Indicative Proposal', ML, 20);

    T('normal', 8, MGREY);
    doc.text('Generated: ' + calculationData.date, PW - MR, 20, { align: 'right' });

    doc.setDrawColor(...LGREY);
    doc.setLineWidth(0.4);
    doc.line(ML, 24, PW - MR, 24);

    // ── TWO-COLUMN SECTIONS (start directly after header) ────────────
    const startY = 28;

    // LEFT: Building Specifications
    let ly = sectionHead('Building Specifications', BLUE, [235, 244, 255], C1L, startY, COL_W);
    ly = dataRow('Dimensions:', inp.length + 'm x ' + inp.width + 'm', C1L, ly, COL_W);
    ly = dataRow('Total Roof Area:', r.roofArea.toFixed(0) + ' m2', C1L, ly, COL_W);
    ly = dataRow('Usable Roof (80%):', (r.roofArea * 0.8).toFixed(0) + ' m2', C1L, ly, COL_W);
    ly = dataRow('Roof Type:', inp.roofType === 'pitched' ? 'Pitched' : 'Flat', C1L, ly, COL_W);
    ly = dataRow('Region:', inp.region.charAt(0).toUpperCase() + inp.region.slice(1), C1L, ly, COL_W);

    ly += 5;

    // LEFT: Proposed System
    ly = sectionHead('Proposed System', BLUE, [235, 244, 255], C1L, ly, COL_W);
    ly = dataRow('System Size:', r.systemSizeKw.toFixed(2) + ' kWp', C1L, ly, COL_W);
    ly = dataRow('No. of Panels:', fmt(r.maxPanels) + ' x 450W', C1L, ly, COL_W);
    ly = dataRow('Year 1 Generation:', fmt(r.yearOneGeneration) + ' kWh', C1L, ly, COL_W);
    ly = dataRow('30-Year Generation:', fmt(r.totalGeneration) + ' kWh', C1L, ly, COL_W);

    // RIGHT: Financial Summary
    let ry = sectionHead('Financial Summary', AMBER, [255, 251, 235], C2L, startY, COL_W);
    ry = dataRow('Installation Cost:', 'GBP ' + fmt(r.totalCost), C2L, ry, COL_W);
    ry = dataRow('30-Year Savings:', 'GBP ' + fmt(r.totalSavings), C2L, ry, COL_W);
    ry = dataRow('Net Profit (30yr):', 'GBP ' + fmt(r.totalSavings - r.totalCost), C2L, ry, COL_W);
    ry = dataRow('Return on Investment:', r.roi.toFixed(1) + '%', C2L, ry, COL_W);
    ry = dataRow('Payback Period:', r.paybackYear.toFixed(1) + ' years', C2L, ry, COL_W);

    ry += 5;

    // RIGHT: Environmental & Key Inputs
    ry = sectionHead('Environmental & Key Inputs', GREEN, [236, 253, 245], C2L, ry, COL_W);
    ry = dataRow('CO2 Offset (30yr):', r.carbonOffset.toFixed(1) + ' tonnes', C2L, ry, COL_W);
    ry = dataRow('Self-Consumption Rate:', '90%', C2L, ry, COL_W);
    ry = dataRow('Energy Price (yr 1):', inp.energyPrice + 'p / kWh', C2L, ry, COL_W);
    ry = dataRow('Cost Basis:', inp.roofType === 'pitched' ? 'GBP 800 / kWp' : 'GBP 900 / kWp', C2L, ry, COL_W);

    // ── CHART ─────────────────────────────────────────────────────────
    let chartY = Math.max(ly, ry) + 6;
    doc.setDrawColor(...LGREY);
    doc.setLineWidth(0.4);
    doc.line(ML, chartY, PW - MR, chartY);
    chartY += 5;

    T('bold', 9, BLUE);
    doc.text('Break-Even Analysis: Cumulative Savings vs Initial Investment', PW / 2, chartY, { align: 'center' });
    chartY += 4;

    const chartImg = document.getElementById('savingsChart').toDataURL('image/png');
    const chartH   = 58;
    doc.addImage(chartImg, 'PNG', ML, chartY, CW, chartH);
    chartY += chartH + 5;

    // ── ASSUMPTIONS ───────────────────────────────────────────────────
    doc.setDrawColor(...LGREY);
    doc.setLineWidth(0.4);
    doc.line(ML, chartY, PW - MR, chartY);
    chartY += 4;

    T('bold', 8.5, SLATE);
    doc.text('Key Assumptions & Limitations', ML, chartY);
    chartY += 5;

    T('normal', 7.2, DGREY);
    const assumptions = [
      'Maintenance costs are NOT included. Annual maintenance typically costs GBP 15-20 per kWp per year.',
      'Roof coverage: 80% of total roof area assumed usable, accounting for edge setbacks, obstructions, vents and inter-row spacing.',
      'Self-consumption: 90% of generation consumed on-site at import rate. The remaining 10% exported is not valued.',
      'Panel degradation: 2% per year. Electricity price inflation: 3% per year.',
      'Panel specification: 450W, 2.27m x 1.13m. Overall system efficiency: 85%.',
      'Carbon factor: 0.233 kg CO2 per kWh (UK grid average).',
      'Does not include costs for scaffolding, structural surveys, or any grid connection costs or upgrades.',
    ];
    assumptions.forEach(function(a, i) {
      const lines = doc.splitTextToSize((i + 1) + '.  ' + a, CW - 4);
      doc.text(lines, ML, chartY);
      chartY += lines.length * 3.6 + 2;
    });

    // ── IMPORTANT NOTICE (bottom of page) ────────────────────────────
    doc.setDrawColor(...LGREY);
    doc.setLineWidth(0.4);
    doc.line(ML, chartY, PW - MR, chartY);
    chartY += 4;

    // Pre-calculate all text to size the box correctly before drawing it
    const discText    = 'This is a rough, hypothetical calculation based on very basic input information. For a more detailed design and accurate costings and savings please contact:';
    const contactLine = 'Martyn Sheridan  |  martynsheridan@gmail.com  |  +44 (0) 787 2015769';
    const maxTextW    = CW - 12;
    T('normal', 7.2, [100, 60, 0]);
    const discLines    = doc.splitTextToSize(discText, maxTextW);
    T('bold', 7.5, [130, 80, 0]);
    const contactLines = doc.splitTextToSize(contactLine, maxTextW);

    const LINE_H   = 3.8;
    const topPad   = 5;    // space above "IMPORTANT NOTICE" label
    const labelH   = 5;    // height of the bold label row
    const bodyGap  = 2;    // gap between label and body text
    const contactGap = 2;  // gap between body and contact line
    const botPad   = 4;    // padding below contact line

    const boxH = topPad + labelH + bodyGap
               + discLines.length   * LINE_H
               + contactGap
               + contactLines.length * LINE_H
               + botPad;

    // Draw box with calculated height
    doc.setFillColor(255, 251, 235);
    doc.setDrawColor(...AMBER);
    doc.setLineWidth(0.4);
    doc.roundedRect(ML, chartY, CW, boxH, 1.5, 1.5, 'FD');
    // Left accent strip — must match full box height
    doc.setFillColor(...AMBER);
    doc.rect(ML, chartY, 3, boxH, 'F');

    // Label
    T('bold', 7.5, RED);
    doc.text('IMPORTANT NOTICE', ML + 6, chartY + topPad);

    // Body text
    T('normal', 7.2, [100, 60, 0]);
    const bodyY = chartY + topPad + labelH + bodyGap;
    doc.text(discLines, ML + 6, bodyY);

    // Contact line
    T('bold', 7.5, [130, 80, 0]);
    const contactY = bodyY + discLines.length * LINE_H + contactGap;
    doc.text(contactLines, ML + 6, contactY);

    // ── FOOTER ────────────────────────────────────────────────────────
    doc.setFillColor(...AMBER);
    doc.rect(0, PH - 3, PW, 3, 'F');
    T('italic', 7, MGREY);
    doc.text('Estimates only. Actual performance may vary. Consult a certified installer for a full site assessment.', PW / 2, PH - 6, { align: 'center' });

    doc.save('Solar-Proposal-' + calculationData.date.replace(/\//g, '-') + '.pdf');
  }
</script>
</body>
</html>